# ComfyUI Auto-Installer - Development Guide

**For complete architecture documentation, see `/codemaps/`**

## Quick Reference

- **Architecture**: See `/codemaps/architecture.md`
- **Backend Scripts**: See `/codemaps/backend.md`
- **Data Models**: See `/codemaps/data.md`
- **UI Patterns**: See `/codemaps/frontend.md`

## Development Priorities for Agentic Coding

### 1. Security First (Installer-Specific)

**This is an installer - security is critical:**

```powershell
# ALWAYS validate downloads
# GOOD:
$hash = Get-FileHash $downloadedFile -Algorithm SHA256
if ($hash.Hash -ne $expectedHash) {
    throw "Checksum mismatch! Possible corruption or tampering."
}

# ALWAYS use TLS 1.2+
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# NEVER use Invoke-Expression with external input
# BAD: Invoke-Expression (Invoke-WebRequest $url).Content
# GOOD: Download to file, validate, then dot-source or import
```

**Admin Elevation:**
- Only elevate when absolutely necessary (Long Paths, VS Build Tools)
- Use self-elevation pattern with `-RunAdminTasks` flag
- Never permanently modify system execution policy

### 2. PowerShell Best Practices

**Path Handling:**
```powershell
# ALWAYS use Join-Path
$configFile = Join-Path $scriptPath "dependencies.json"  # ✅
$configFile = "$scriptPath\dependencies.json"             # ❌

# Handle spaces in paths
& "C:\Program Files\Tool\tool.exe" args  # ✅ Quote the executable
C:\Program Files\Tool\tool.exe args      # ❌ Breaks with spaces
```

**Error Handling:**
```powershell
# Use Invoke-AndLog from UmeAiRTUtils.psm1
Invoke-AndLog -File "git" -Arguments "clone $url $path"

# For critical operations
try {
    # Operation
} catch {
    Write-Log "ERROR: $($_.Exception.Message)" -Level 0 -Color Red
    throw  # Re-throw to stop installation
}
```

**Logging:**
```powershell
# Use Write-Log from UmeAiRTUtils.psm1
Write-Log "Installing ComfyUI..." -Level 0  # Step header
Write-Log "Cloning repository" -Level 1      # Main item
Write-Log "Using branch: main" -Level 2      # Sub-item
Write-Log "Git output: ..." -Level 3         # Debug
```

### 3. Junction-Based Architecture (Critical)

**Never modify ComfyUI core folders directly:**
```powershell
# ✅ CORRECT - Use external folders
$modelsPath = Join-Path $installPath "models"
New-Item -ItemType Directory -Path $modelsPath -Force

# Create junction inside ComfyUI
$comfyModels = Join-Path $comfyPath "models"
cmd /c mklink /J "$comfyModels" "$modelsPath"

# ❌ WRONG - Don't put models in ComfyUI directly
# This breaks updates (git pull would conflict)
```

**Why:** Allows clean git pull updates without losing user data.

### 4. Dependency Management

**Priority Order (Critical):**

1. **Primary**: `snapshot.json` via ComfyUI-Manager CLI
   ```powershell
   & python (Join-Path $managerPath "cm-cli.py") restore-snapshot -p $snapshotFile
   ```

2. **Fallback**: `custom_nodes.csv` if snapshot missing
   ```powershell
   Import-Csv $csvFile | ForEach-Object {
       & python (Join-Path $managerPath "cm-cli.py") install $_.RepoUrl
   }
   ```

**Never:** Install custom nodes manually (breaks snapshot integrity)

### 5. Model Downloads

**VRAM-Aware Recommendations:**
```powershell
# Get GPU info first
$gpuInfo = Get-GpuVramInfo

# Filter models by VRAM
$recommendedModels = $allModels | Where-Object {
    $_.MinVRAM -le $gpuInfo.VramGB
}

# Display with VRAM requirements
Write-Host "  - $($model.Name) ($($model.MinVRAM) GB required)"
```

**Use aria2c for speed:**
```powershell
Save-File -Uri $url -OutFile $destination  # Uses aria2c with fallback
```

### 6. Environment Activation Patterns

**Detect installation type:**
```powershell
$installTypeFile = Join-Path $scriptPath "install_type"
$installType = Get-Content $installTypeFile

if ($installType -eq "conda") {
    & "$condaExe" activate UmeAiRT
} else {
    & (Join-Path $scriptPath "venv\Scripts\Activate.ps1")
}
```

### 7. Testing Checklist

Before committing changes:

- [ ] Test on **fresh Windows 10 VM** (no Python/Git installed)
- [ ] Test on **fresh Windows 11 VM**
- [ ] Test **Light mode** (venv with system Python 3.13)
- [ ] Test **Full mode** (Miniconda installation)
- [ ] Test with **existing Python 3.13** installed
- [ ] Test on **different drive** (not C:)
- [ ] Test **update script** after fresh install
- [ ] Verify **junction creation** (external folders persist after updates)
- [ ] Test **model downloads** with slow network
- [ ] Check **error recovery** (interrupt during git clone, download)

### 8. Critical Files - Don't Break These

**dependencies.json:**
- Schema must match exactly (see `/codemaps/data.md`)
- All URLs must be HTTPS
- PyTorch index URL must stay synchronized with version

**snapshot.json:**
- Generated by ComfyUI-Manager - don't hand-edit
- Regenerate after testing new custom nodes
- Commit hash pins are critical for reproducibility

**UmeAiRTUtils.psm1:**
- Shared by all scripts - changes affect everything
- Test thoroughly before modifying
- Maintain backward compatibility (update scripts depend on it)

### 9. Common Pitfalls to Avoid

❌ **Don't**: Use `cd` (changes working directory, breaks relative paths)
✅ **Do**: Use `-WorkingDirectory` parameter or absolute paths

❌ **Don't**: Hardcode Python paths (`C:\Python313\python.exe`)
✅ **Do**: Use detected Python or environment activation

❌ **Don't**: Assume admin rights (check with `Test-IsAdmin`)
✅ **Do**: Elevate only when necessary

❌ **Don't**: Modify `ComfyUI/` repository files (breaks git pull)
✅ **Do**: Use junctions or modify external folders

❌ **Don't**: Skip error handling ("it won't fail")
✅ **Do**: Wrap risky operations in try-catch

### 10. When Adding New Features

**New Custom Node:**
1. Test installation manually first
2. Add to `custom_nodes.csv` (fallback method)
3. Install via ComfyUI-Manager, regenerate `snapshot.json`
4. Test both snapshot and CSV installation paths
5. Update documentation

**New Model Downloader:**
1. Copy pattern from `Download-FLUX-Models.ps1`
2. Define model metadata with VRAM requirements
3. Use `Save-File` (aria2c + fallback)
4. Place in correct `models/` subdirectory
5. Add menu entry to Phase 2 installer
6. Test with both high/low VRAM GPUs

**New Dependency:**
1. Add to `dependencies.json` under correct section
2. Test installation order (some packages depend on others)
3. Check for CUDA compatibility (cu130 suffix)
4. Verify on both Light and Full installation modes
5. Test update path (existing installations)

## Relevant Skills (User-Level)

For working on this project, these skills are most useful:

- **python-patterns, python-testing**: Understanding ComfyUI custom nodes
- **security-review, security-scan**: Critical for installer security
- **deployment-patterns**: Release process, versioning
- **verification-loop**: Pre-commit quality checks

## Project-Specific Commands

**Regenerate codemaps after changes:**
```powershell
.\codemaps\Generate-Codemaps.ps1
```

**Test installation from scratch:**
```powershell
# Clean test directory
Remove-Item -Recurse -Force C:\ComfyUI-Test
mkdir C:\ComfyUI-Test
cd C:\ComfyUI-Test

# Download and run installer
.\UmeAiRT-Install-ComfyUI.bat
```

**Check for broken junctions:**
```powershell
Get-ChildItem C:\ComfyUI-Install\ComfyUI -Force | Where-Object {
    $_.Attributes -match "ReparsePoint"
} | ForEach-Object {
    if (-not (Test-Path $_.FullName)) {
        Write-Host "BROKEN: $($_.FullName)" -ForegroundColor Red
    }
}
```

## File Size Guidelines

- PowerShell scripts: **200-500 lines** (800 max before splitting)
- Extract reusable functions to `UmeAiRTUtils.psm1`
- Split complex downloaders into separate files (already done well)

## Immutability for Configuration

```powershell
# ❌ BAD - Modifying user's original files
$config = Get-Content config.json | ConvertFrom-Json
$config.setting = "new value"
$config | ConvertTo-Json | Set-Content config.json

# ✅ GOOD - Create new object, backup original
Copy-Item config.json config.json.bak
$oldConfig = Get-Content config.json | ConvertFrom-Json
$newConfig = @{
    setting = "new value"
    # Preserve other settings
}
$newConfig | ConvertTo-Json | Set-Content config.json
```

## Questions?

- Review `/codemaps/` for architecture details
- Check `UmeAiRTUtils.psm1` for shared functions
- Test changes on fresh VM before committing
- Preserve junction architecture (external folders)

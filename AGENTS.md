# ComfyUI Auto-Installer - Agent Development Guide

> Instructions for AI coding agents working on this project.
> For architecture details, see `/codemaps/`.

## Project Overview

PowerShell-based installer for ComfyUI on Windows. Downloads and configures ComfyUI, custom nodes, models, and Python environments (venv or Miniconda). Key characteristic: **junction-based architecture** keeps user data separate from the ComfyUI git repo for clean updates.

## Build / Test / Run

```powershell
# Regenerate codemaps after structural changes
.\codemaps\Generate-Codemaps.ps1

# Test installation from scratch
Remove-Item -Recurse -Force C:\ComfyUI-Test
mkdir C:\ComfyUI-Test
cd C:\ComfyUI-Test
.\UmeAiRT-Install-ComfyUI.bat

# Check for broken junctions
Get-ChildItem C:\ComfyUI-Install\ComfyUI -Force | Where-Object {
    $_.Attributes -match "ReparsePoint"
} | ForEach-Object {
    if (-not (Test-Path $_.FullName)) {
        Write-Host "BROKEN: $($_.FullName)" -ForegroundColor Red
    }
}
```

## Critical Conventions

### Junction-Based Architecture

**Never modify ComfyUI core folders directly.** User data (models, outputs, custom nodes) lives in external folders, symlinked into ComfyUI via NTFS junctions. This allows `git pull` updates without data loss.

```powershell
# CORRECT - Use external folders with junctions
$modelsPath = Join-Path $installPath "models"
New-Item -ItemType Directory -Path $modelsPath -Force
cmd /c mklink /J "$comfyModels" "$modelsPath"

# WRONG - Putting files in ComfyUI directly breaks git pull
Copy-Item $model (Join-Path $comfyPath "models\file.safetensors")
```

### Security First

This is an installer that downloads and executes code. Security is critical.

```powershell
# ALWAYS validate downloads
$hash = Get-FileHash $downloadedFile -Algorithm SHA256
if ($hash.Hash -ne $expectedHash) {
    throw "Checksum mismatch! Possible corruption or tampering."
}

# ALWAYS use TLS 1.2+
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# NEVER use Invoke-Expression with external input
# BAD: Invoke-Expression (Invoke-WebRequest $url).Content
# GOOD: Download to file, validate, then dot-source or import
```

**Admin Elevation:**
- Only elevate when absolutely necessary
- Use self-elevation pattern with `-RunAdminTasks` flag
- Never permanently modify system execution policy

### PowerShell Patterns

**Path Handling - ALWAYS use Join-Path:**
```powershell
$configFile = Join-Path $scriptPath "dependencies.json"  # Correct
$configFile = "$scriptPath\dependencies.json"             # Wrong
```

**Quote executables with spaces:**
```powershell
& "C:\Program Files\Tool\tool.exe" args  # Correct - call operator with quoted path
C:\Program Files\Tool\tool.exe args      # Wrong - breaks on spaces
```

**Error Handling - Use project utilities:**
```powershell
# Preferred: Use Invoke-AndLog from UmeAiRTUtils.psm1
Invoke-AndLog -File "git" -Arguments "clone $url $path"

# For critical operations: explicit try-catch
try {
    # Operation
} catch {
    Write-Log "ERROR: $($_.Exception.Message)" -Level 0 -Color Red
    throw
}
```

**Logging - Use Write-Log from UmeAiRTUtils.psm1:**
```powershell
Write-Log "Installing ComfyUI..." -Level 0  # Step header
Write-Log "Cloning repository" -Level 1      # Main item
Write-Log "Using branch: main" -Level 2      # Sub-item
Write-Log "Git output: ..." -Level 3         # Debug
```

## Dependency Management

**Priority Order:**
1. **Primary:** `snapshot.json` via ComfyUI-Manager CLI
2. **Fallback:** `custom_nodes.csv` if snapshot missing

**Never** install custom nodes manually - it breaks snapshot integrity.

`snapshot.json` is auto-generated by ComfyUI-Manager. Don't hand-edit it. To regenerate:
```powershell
python cm-cli.py save-snapshot --output path/to/snapshot.json
```

## Critical Files

| File | Notes |
|------|-------|
| `dependencies.json` | Schema must match exactly. All URLs must be HTTPS. PyTorch index URL must stay synchronized with version. |
| `snapshot.json` | Auto-generated by ComfyUI-Manager. Regenerate after testing new custom nodes. Don't hand-edit. |
| `UmeAiRTUtils.psm1` | Shared by all scripts. Changes affect everything. Maintain backward compatibility. |

## Common Pitfalls

| Don't | Do Instead |
|-------|-----------|
| Use `cd` (changes global state) | Use `-WorkingDirectory` or absolute paths |
| Hardcode Python paths | Use detected Python or environment activation |
| Assume admin rights | Check with `Test-IsAdmin`, elevate only when necessary |
| Modify `ComfyUI/` repo files | Use junctions or modify external folders |
| Skip error handling | Wrap risky operations in try-catch |
| Hand-edit `snapshot.json` | Regenerate via ComfyUI-Manager |

## Adding New Features

**New Custom Node:**
1. Test installation manually first
2. Add to `custom_nodes.csv` (fallback method)
3. Install via ComfyUI-Manager, regenerate `snapshot.json`
4. Test both snapshot and CSV installation paths

**New Model Downloader:**
1. Copy pattern from `Download-FLUX-Models.ps1`
2. Define model metadata with VRAM requirements
3. Use `Save-File` (aria2c + fallback)
4. Place in correct `models/` subdirectory
5. Add menu entry to Phase 2 installer

**New Dependency:**
1. Add to `dependencies.json` under correct section
2. Test installation order (some packages depend on others)
3. Check for CUDA compatibility (cu130 suffix)
4. Verify on both Light and Full installation modes
5. Test update path (existing installations)

## Environment Detection

```powershell
# Detect installation type (venv vs conda)
$installTypeFile = Join-Path $scriptPath "install_type"
$installType = Get-Content $installTypeFile

if ($installType -eq "conda") {
    # Conda requires hook initialization in PowerShell.
    # This is an approved exception to the Invoke-Expression rule â€”
    # the hook output comes from the local conda binary, not external input.
    (& "$condaExe" shell.powershell hook) | Invoke-Expression
    conda activate UmeAiRT
} else {
    & (Join-Path $scriptPath "venv\Scripts\Activate.ps1")
}
```

## File Size Guidelines

- PowerShell scripts: 200-500 lines typical, 800 max before splitting
- Extract reusable functions to `UmeAiRTUtils.psm1`

## Testing Checklist

- [ ] Test on fresh Windows 10 VM (no Python/Git installed)
- [ ] Test on fresh Windows 11 VM
- [ ] Test Light mode (venv with system Python 3.13)
- [ ] Test Full mode (Miniconda installation)
- [ ] Test with existing Python 3.13 installed
- [ ] Test on different drive (not C:)
- [ ] Test update script after fresh install
- [ ] Verify junction creation (external folders persist after updates)
- [ ] Test model downloads with slow network
- [ ] Check error recovery (interrupt during git clone, download)

## Configuration Immutability

```powershell
# WRONG - Modifying user's original files in place
$config = Get-Content config.json | ConvertFrom-Json
$config.setting = "new value"
$config | ConvertTo-Json | Set-Content config.json

# RIGHT - Backup original, deep-clone and update
Copy-Item config.json config.json.bak
$config = Get-Content config.json | ConvertFrom-Json
$newConfig = $config | ConvertTo-Json -Depth 10 | ConvertFrom-Json  # Deep clone
$newConfig.setting = "new value"
$newConfig | ConvertTo-Json -Depth 10 | Set-Content config.json
```
